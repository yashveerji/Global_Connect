<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WebRTC ICE Test</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; }
    input, button { padding: 8px 10px; font-size: 14px; }
    .row { display:flex; gap:8px; margin-bottom:10px; flex-wrap: wrap; }
    pre { background:#f6f8fa; padding:10px; border-radius:8px; overflow:auto; }
    .ok { color: #067d19; font-weight:600; }
    .warn { color: #b54708; font-weight:600; }
    .err { color: #b42318; font-weight:600; }
  </style>
</head>
<body>
  <h1>WebRTC ICE/TURN Smoke Test</h1>
  <div class="row">
    <input id="server" placeholder="Backend URL (https://your-backend)" style="min-width:360px" />
    <button id="btnFetch">Fetch ICE</button>
    <button id="btnGather" disabled>Gather Candidates</button>
  </div>
  <div id="iceStatus"></div>
  <h3>ICE Servers</h3>
  <pre id="iceOut">(none)</pre>
  <h3>Candidates</h3>
  <pre id="candOut">(none)</pre>

  <script>
    const $ = s => document.querySelector(s);
    let iceServers = [];
    let candidates = [];

    function showServers() {
      $("#iceOut").textContent = JSON.stringify(iceServers, null, 2);
      const hasTurn = iceServers.some(s => {
        const u = Array.isArray(s.urls) ? s.urls : [s.urls];
        return u && u.some(x => String(x).startsWith('turn:') || String(x).startsWith('turns:')) && s.username && s.credential;
      });
      $("#iceStatus").innerHTML = hasTurn
        ? '<span class="ok">TURN present in ICE servers</span>'
        : '<span class="warn">No TURN in ICE servers (STUN only)</span>';
    }

    $("#btnFetch").onclick = async () => {
      const base = $("#server").value.trim();
      if (!base) { alert('Enter backend URL'); return; }
      $("#iceOut").textContent = 'Loading…';
      try {
        const res = await fetch(`${base.replace(/\/$/, '')}/api/rtc/ice`, { credentials: 'include' });
        const data = await res.json();
        iceServers = data.iceServers || [];
      } catch (e) {
        iceServers = [];
      }
      if (!iceServers.length) {
        // Fallback to Google STUN so the gather test can still run
        iceServers = [{ urls: 'stun:stun.l.google.com:19302' }];
      }
      showServers();
      $("#btnGather").disabled = false;
    };

    $("#btnGather").onclick = async () => {
      candidates = [];
      $("#candOut").textContent = 'Gathering…';
      const pc = new RTCPeerConnection({ iceServers });
      pc.onicecandidate = ({ candidate }) => {
        if (!candidate) return; // done
        candidates.push(candidate);
        $("#candOut").textContent = candidates.map(c => `${c.candidate}`).join('\n');
      };
      // Use a dummy data channel to trigger ICE gathering
      pc.createDataChannel('test');
      const offer = await pc.createOffer({ offerToReceiveAudio: false, offerToReceiveVideo: false });
      await pc.setLocalDescription(offer);
      // Stop after a few seconds
      setTimeout(() => {
        try { pc.close(); } catch {}
        const hasRelay = candidates.some(c => / typ relay /.test(c.candidate));
        const status = hasRelay
          ? '<span class="ok">Relay candidate found (TURN working)</span>'
          : '<span class="warn">No relay candidates (TURN likely not used)</span>';
        $("#candOut").innerHTML = `${$("#candOut").textContent}\n\n${status}`;
      }, 3500);
    };
  </script>
</body>
</html>
