<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WebRTC 1:1 Call</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    video { width: 100%; background: #000; border-radius: 8px; }
    .controls { display: flex; gap: 8px; margin: 12px 0; flex-wrap: wrap; }
    input, button { padding: 8px 12px; font-size: 14px; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; white-space: pre-wrap; background:#f6f8fa; padding:8px; border-radius:8px; }
  </style>
</head>
<body>
  <h1>WebRTC 1:1 Call (Socket.io)</h1>
  <div class="controls">
    <input id="room" placeholder="room-id e.g. demo123" />
    <input id="signaling" placeholder="https://your-backend.onrender.com" style="min-width:320px" />
    <button id="btnJoin">Join</button>
    <button id="btnLeave" disabled>Leave</button>
    <button id="btnMute" disabled>Mute</button>
    <button id="btnVideo" disabled>Video Off</button>
  </div>
  <div class="grid">
    <div>
      <h3>Me</h3>
      <video id="local" autoplay playsinline muted></video>
    </div>
    <div>
      <h3>Peer</h3>
      <video id="remote" autoplay playsinline></video>
    </div>
  </div>
  <h3>Logs</h3>
  <div id="log" class="log"></div>

  <!-- Socket.io client -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script>
    let pc, socket, localStream, roomId = null, micOn = true, camOn = true;
    const $ = (s) => document.querySelector(s);
    const log = (m) => { const el = $("#log"); el.textContent += `\n${new Date().toLocaleTimeString()} â€” ${m}`; el.scrollTop = el.scrollHeight; };

    function makePC() {
      pc = new RTCPeerConnection({
        iceServers: [ { urls: 'stun:stun.l.google.com:19302' } ]
      });
      pc.ontrack = (e) => { $("#remote").srcObject = e.streams[0]; log('Remote track'); };
      pc.onicecandidate = ({ candidate }) => { if (candidate && roomId) socket.emit('ice-candidate', { roomId, candidate }); };
      return pc;
    }

    async function getMedia() {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      $("#local").srcObject = localStream;
      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
      log('Got media');
    }

    async function createOffer() {
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      socket.emit('offer', { roomId, sdp: offer });
      log('Sent offer');
    }
    async function handleOffer({ sdp }) {
      await pc.setRemoteDescription(new RTCSessionDescription(sdp));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      socket.emit('answer', { roomId, sdp: answer });
      log('Answered');
    }
    async function handleAnswer({ sdp }) { await pc.setRemoteDescription(new RTCSessionDescription(sdp)); log('Set answer'); }
    async function handleIce({ candidate }) { try { await pc.addIceCandidate(candidate); log('ICE added'); } catch(e) { log('ICE error '+e.message); } }

    $("#btnJoin").onclick = async () => {
      const url = $("#signaling").value.trim();
      roomId = $("#room").value.trim();
      if (!url || !roomId) { alert('Enter signaling URL and room'); return; }
      makePC();
      await getMedia();
      socket = io(url, { withCredentials: true });
      socket.on('connect', () => log('Socket connected'));
      socket.on('joined', ({ peers }) => { log(`Joined. Peers: ${peers}`); if (peers === 1) createOffer(); });
      socket.on('peer-joined', () => log('Peer joined'));
      socket.on('offer', handleOffer);
      socket.on('answer', handleAnswer);
      socket.on('ice-candidate', handleIce);
      socket.on('peer-left', () => { log('Peer left'); $("#remote").srcObject = null; });
      socket.on('room-full', () => { log('Room full'); alert('Room already has 2 participants'); });
      socket.emit('join', { roomId });
      $("#btnLeave").disabled = false; $("#btnMute").disabled = false; $("#btnVideo").disabled = false;
    };

    $("#btnLeave").onclick = () => {
      if (socket && roomId) socket.emit('leave', { roomId });
      pc.getSenders().forEach(s => s.track && s.track.stop());
      $("#local").srcObject = null; $("#remote").srcObject = null;
      socket && socket.disconnect();
      log('Left room');
      $("#btnLeave").disabled = true; $("#btnMute").disabled = true; $("#btnVideo").disabled = true;
    };
    $("#btnMute").onclick = () => { micOn = !micOn; localStream.getAudioTracks().forEach(t => t.enabled = micOn); $("#btnMute").textContent = micOn ? 'Mute' : 'Unmute'; };
    $("#btnVideo").onclick = () => { camOn = !camOn; localStream.getVideoTracks().forEach(t => t.enabled = camOn); $("#btnVideo").textContent = camOn ? 'Video Off' : 'Video On'; };
  </script>
</body>
</html>
